<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kariba Online - Colorful Badge</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; text-align: center; background: #dfe6e9; margin: 0; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; }
        #lobby, #gameUI { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }

        /* ë³´ë“œ ìŠ¤íƒ€ì¼ */
        .board { display: flex; justify-content: center; gap: 15px; margin: 30px 0; padding: 20px; background: #f1f2f6; border-radius: 15px;}
        .slot {
            width: 80px; height: 140px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            position: relative; border-bottom: 4px solid transparent; transition: 0.3s; padding-bottom: 5px;
        }
        .slot.active { border-bottom-color: #ff4757; transform: translateY(-5px); }
        .card-img-board { width: 70px; height: 105px; object-fit: cover; border-radius: 8px; box-shadow: 3px 3px 8px rgba(0,0,0,0.2); }

        /* [ìˆ˜ì •] ê³µí†µ ë°°ì§€ ìŠ¤íƒ€ì¼: ê¸€ììƒ‰ í°ìƒ‰ ê³ ì • */
        .num-badge {
            color: white !important;
            font-weight: 900;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid white; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        /* ë³´ë“œìš© ìˆ«ì ë°°ì§€ */
        .board-num-badge {
            position: absolute; top: 10px; left: 5px;
            width: 32px; height: 32px; border-radius: 50%;
            font-size: 1.2em;
        }

        /* ì†íŒ¨ìš© ìˆ«ì ë°°ì§€ */
        .hand-num-badge {
            position: absolute; top: -10px; left: -10px;
            padding: 5px 12px; border-radius: 12px;
            font-size: 1.3em;
        }

        .slot-count { margin-top: 5px; font-weight: bold; color: #636e72; font-size: 0.9em; }

        /* ì†íŒ¨ ìŠ¤íƒ€ì¼ */
        .hand { margin-top: 30px; padding: 25px; background: #74b9ff; border-radius: 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        .hand h3 { color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); margin-top: 0;}
        .card-btn { padding: 0; margin: 15px 10px 5px 10px; border: none; background: none; cursor: pointer; position: relative; transition: 0.25s ease;}
        .card-btn:hover:not(:disabled) { transform: translateY(-15px) scale(1.05); z-index: 10; }
        .card-btn:disabled { filter: grayscale(80%) brightness(70%); cursor: not-allowed; }
        .card-img-hand { width: 90px; height: 135px; object-fit: cover; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 3px solid white; }

        /* ë³´ìœ  ê°œìˆ˜ ë°°ì§€ (ìš°ì¸¡ í•˜ë‹¨) */
        .count-badge {
            position: absolute; bottom: -8px; right: -8px;
            background: #ff4757; color: white;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1em;
            border: 2px solid white; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); z-index: 15;
        }

        /* ê¸°ì¡´ UI ì»´í¬ë„ŒíŠ¸ */
        .score-card { text-align: left; padding: 15px; border-bottom: 1px solid #eee; transition: 0.3s; }
        .score-card.active { background: #e3f2fd; border-left: 6px solid #1e90ff; }
        .captured { font-size: 0.9em; color: #444; margin-top: 8px; padding: 8px 12px; background: #f1f2f6; border-radius: 8px; line-height: 1.6; }
        .captured b { color: #ff4757; font-size: 1.1em; }
        .btn-main { padding: 12px 30px; background: #00b894; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1em;}
        .btn-pass { background: #fdcb6e; color: #2d3436; padding: 12px 25px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; box-shadow: 0 4px 0 #e1b12c;}
        #victoryBanner { display: none; background: #ff7675; color: white; padding: 20px; border-radius: 15px; font-size: 2em; font-weight: bold; margin-bottom: 25px; }
        .last-warning { color: #d63031; font-weight: bold; animation: blink 0.8s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        #turnInfo { font-size: 1.4em; color:#0984e3; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color:#2d3436;">ğŸ˜ KARIBA ONLINE</h1>

        <div id="lobby">
            <h2>ëŒ€ê¸°ì‹¤</h2>
            <div id="joinArea">
                <input type="text" id="nameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" style="padding:12px; width:250px; border-radius:8px; border:1px solid #ddd;">
                <button class="btn-main" onclick="joinGame()">ì…ì¥í•˜ê¸°</button>
            </div>
            <div id="waitingArea" style="display:none;">
                <p>í”Œë ˆì´ì–´ ëŒ€ê¸° ì¤‘...</p>
                <ul id="pList" style="list-style:none; padding:0; font-weight:bold; font-size:1.3em;"></ul>
                <button id="startBtn" class="btn-main" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
            </div>
        </div>

        <div id="gameUI" style="display:none;">
            <div id="victoryBanner">
                ğŸ† <span id="winnerName"></span> ìŠ¹ë¦¬! ğŸ†
                <br>
                <button class="btn-main" style="background:white; color:#ff7675; margin-top:15px;" onclick="resetGame()">ë‹¤ì‹œí•˜ê¸°</button>
            </div>

            <div style="display:flex; justify-content: space-between; font-weight: bold; margin-bottom:20px; align-items: center; background:#fff; padding:15px; border-radius:15px;">
                <div id="turnInfo"></div>
                <div id="lastRoundMsg" class="last-warning" style="display:none;">ğŸ”¥ ë§ˆì§€ë§‰ ë¼ìš´ë“œ! ğŸ”¥</div>
                <div id="deckInfo" style="color:#636e72;"></div>
            </div>

            <div class="board" id="boardDisplay"></div>
            <div id="scoreDisplay" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>

            <div class="hand" id="handArea">
                <h3>ğŸ–ï¸ ë‚´ ì†íŒ¨</h3>
                <div id="myHand" style="display:flex; justify-content: center; flex-wrap: wrap; min-height: 160px; align-items: center;"></div>
                <button id="passBtn" class="btn-pass" onclick="confirmPass()">í„´ ë„˜ê¸°ê¸° (PASS)</button>
            </div>
            <button style="background:transparent; color:#b2bec3; border:none; margin-top:30px; cursor:pointer;" onclick="resetGame()">ê²Œì„ ì´ˆê¸°í™”</button>
        </div>
    </div>

    <script>
        const socket = io();
        const IMG_EXT = '.png';

        // [NEW] ìœ ì €ê°€ ìš”ì²­í•œ ì¹´ë“œë³„ ê³ ìœ  ë°°ê²½ìƒ‰ ì •ì˜
        const CARD_COLORS = {
            1: "#ed8ca0",
            2: "#f15e7b",
            3: "#f4aa7f",
            4: "#f8e682",
            5: "#b3daa9",
            6: "#89a9dc",
            7: "#3e6eac",
            8: "#ab78b1"
        };

        function joinGame() {
            const n = document.getElementById('nameInput').value;
            if(!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            socket.emit('join', n);
            document.getElementById('joinArea').style.display = 'none';
            document.getElementById('waitingArea').style.display = 'block';
        }
        function startGame() { socket.emit('startGame'); }
        function resetGame() { if(confirm("ì´ˆê¸°í™”í• ê¹Œìš”?")) socket.emit('resetGame'); }
        function confirmPass() { if(confirm("í„´ì„ ë„˜ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?")) socket.emit('passTurn'); }

        function askCount(val, max) {
            const res = prompt(`${val}ë²ˆ ì¹´ë“œë¥¼ ëª‡ ì¥ ë‚´ì‹œê² ìŠµë‹ˆê¹Œ? (1~${max})`, "1");
            if(res === null) return;
            const c = parseInt(res);
            if(!isNaN(c) && c >= 1 && c <= max) socket.emit('playCard', { cardValue: val, count: c });
        }

        socket.on('updateState', (state) => {
            document.getElementById('lobby').style.display = state.status === 'LOBBY' ? 'block' : 'none';
            document.getElementById('gameUI').style.display = (state.status === 'PLAYING' || state.status === 'FINISHED') ? 'block' : 'none';

            if(state.status === 'LOBBY') {
                document.getElementById('pList').innerHTML = state.playerOrder.map(id => `<li>ğŸ‘¤ ${state.players[id].name}</li>`).join('');
                document.getElementById('startBtn').disabled = state.playerOrder.length < 2;
                document.getElementById('victoryBanner').style.display = 'none';
            } else {
                const curId = state.playerOrder[state.turnIndex];
                const isMyTurn = socket.id === curId;
                const isFinished = state.status === 'FINISHED';

                if(isFinished) {
                    document.getElementById('victoryBanner').style.display = 'block';
                    document.getElementById('winnerName').innerText = state.winner;
                } else {
                    document.getElementById('victoryBanner').style.display = 'none';
                    document.getElementById('turnInfo').innerText = isMyTurn ? "âš¡ ë‹¹ì‹ ì˜ ì°¨ë¡€!" : `â³ ${state.players[curId].name} ì°¨ë¡€`;
                }

                document.getElementById('deckInfo').innerText = `ë‚¨ì€ ë±: ${state.deck.length}ì¥`;
                document.getElementById('lastRoundMsg').style.display = (state.isLastRound && !isFinished) ? 'block' : 'none';

                // ë³´ë“œ ê·¸ë¦¬ê¸°
                let bHtml = '';
                for(let i=1; i<=8; i++) {
                    const count = state.board[i];
                    const bgColor = CARD_COLORS[i]; // ì¹´ë“œë³„ ìƒ‰ìƒ
                    const content = count > 0
                        ? `<div class="num-badge board-num-badge" style="background:${bgColor}">${i}</div>
                           <img src="/images/card${i}${IMG_EXT}" class="card-img-board">
                           <div class="slot-count">x${count}ì¥</div>`
                        : `<div style="height:105px; width:70px; background:rgba(0,0,0,0.05); border-radius:8px;"></div>
                           <div class="slot-count" style="opacity:0.5">${i}ë²ˆ</div>`;

                    bHtml += `<div class="slot ${count>=3?'active':''}"> ${content} </div>`;
                }
                document.getElementById('boardDisplay').innerHTML = bHtml;

                // ì ìˆ˜íŒ
                document.getElementById('scoreDisplay').innerHTML = state.playerOrder.map(id => {
                    const p = state.players[id];
                    return `<div class="score-card ${(!isFinished && id===curId)?'active':''}">
                        <strong>${p.name}</strong>: ${p.score}ì 
                    </div>`;
                }).join('');

                // ì†íŒ¨ ê·¸ë¦¬ê¸°
                const me = state.players[socket.id];
                const myHandDiv = document.getElementById('myHand');
                myHandDiv.innerHTML = '';
                if(me) {
                    const counts = {};
                    me.hand.forEach(v => counts[v] = (counts[v] || 0) + 1);
                    Object.keys(counts).sort().forEach(v => {
                        const bgColor = CARD_COLORS[v]; // ì¹´ë“œë³„ ìƒ‰ìƒ
                        const btnDisabled = (!isMyTurn || isFinished);
                        myHandDiv.innerHTML += `
                            <button class="card-btn" ${btnDisabled?'disabled':''} onclick="askCount(${v}, ${counts[v]})">
                                <span class="num-badge hand-num-badge" style="background:${bgColor}">${v}</span>
                                <img src="/images/card${v}${IMG_EXT}" class="card-img-hand">
                                <span class="count-badge">x${counts[v]}</span>
                            </button>`;
                    });
                }
                document.getElementById('passBtn').disabled = !isMyTurn || isFinished;
            }
        });
    </script>
</body>
</html>